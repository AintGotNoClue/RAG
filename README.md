
---

### **Описание первичного пайплайна**

#### **Обработка документов**
1. **Загрузка документа**  
   Документ поступает в систему (например, PDF, DOCX или текстовый файл).

2. **Разделение на страницы**  
   Документ делится на страницы, каждая из которых становится отдельной смысловой единицей.

3. **Извлечение метаинформации**  
   С каждой страницы с помощью локальной LLM (Ollama, версия Llama 3.2) извлекаются ключевые метаданные, такие как:
   - Заголовок
   - Дата
   - Основные ключевые слова

4. **Сохранение метаинформации**  
   Метаинформация записывается как часть векторного представления в Qdrant.

5. **Деление на чанки**  
   Каждая страница дополнительно делится на смысловые чанки для оптимизации работы с эмбеддингами.

6. **Генерация summary**  
   Для каждой страницы создаётся краткое содержание (summary) с помощью LLM.

7. **Генерация эмбеддингов**  
   Каждая страница и чанк преобразуются в векторное представление.

8. **Сохранение данных в Qdrant**  
   - Эмбеддинги чанков и summary сохраняются в Qdrant.  
   - Метаинформация хранится вместе с векторами для быстрого поиска.

---

#### **Обработка запросов**
1. **Классификация типа запроса**  
   Запрос анализируется LLM для определения его типа:
   - **Общий**: Не содержит ключевых слов или метаданных.
   - **Смешанный**: Частично уточнённый запрос с некоторыми ключевыми словами.
   - **Абсолютно точный**: Содержит чёткие критерии поиска (например, даты, заголовки, ключевые метаданные).

2. **Уточнение общего запроса**  
   Для общих запросов формируется до 5 уточняющих вопросов по модели RAG-Fusion с использованием Step-back questioning.

3. **Создание запроса в Qdrant**  
   - Для точных запросов используются метаданные и текстовые ключевые слова.
   - Для смешанных запросов выполняется гибридный поиск (метаданные + семантический поиск по эмбеддингам).

4. **Поиск в Qdrant**  
   Из векторного хранилища извлекаются:
   - **10 ближайших чанков** по семантической близости.
   - **5 наиболее релевантных summary** по ключевым словам и метаданным.

5. **Компоновка ответа**  
   Полученные результаты объединяются для формирования финального ответа.

---

### **Архитектура проекта**

```plaintext
project/
│
├── agents/
│   ├── document_processing_agent.py  # Обработка документов: вызовы из pipelines/document_ingestion.py
│   ├── query_handling_agent.py       # Обработка запросов с использованием графа
│   ├── routing_agent.py              # Координация взаимодействия между узлами графа
│   ├── graph.py                      # Основной файл LangGraph: узлы, инструменты, память
│
├── pipelines/
│   ├── document_ingestion.py         # Пайплайн обработки документов
│   ├── query_resolution.py           # Пайплайн обработки запросов
│
├── storage/
│   ├── vector_store.py               # Управление векторным хранилищем Qdrant
│   ├── metadata_store.py             # Управление метаинформацией внутри векторов Qdrant
│
├── utils/
│   ├── chunking.py                   # Деление текста на чанки
│   ├── embedding.py                  # Генерация эмбеддингов для текста
│   ├── summarization.py              # Генерация summary
│   ├── llm_utils.py                  # Взаимодействие с локальной LLM (Ollama)
│
├── configs/
│   ├── settings.py                   # Настройки проекта (пути, параметры LLM и базы данных)
│   ├── qdrant_config.py              # Конфигурация подключения к Qdrant
│
├── data/
│   ├── raw/                          # Исходные документы
│   ├── processed/                    # Обработанные данные (чанки, эмбеддинги)
│
├── tests/
│   ├── test_agents.py                # Проверка логики агентов
│   ├── test_storage.py               # Проверка работы с Qdrant
│   ├── test_pipelines.py             # Проверка пайплайнов
│
└── main.py                           # Точка входа в проект
```

---

### **Описание модулей**

#### **1. `agents/`**
- **`document_processing_agent.py`**  
  Вызывает функции из `pipelines/document_ingestion.py` для обработки документов:
  - Деление на страницы и чанки.
  - Генерация метаинформации и summary.
  - Сохранение данных в Qdrant.
  
- **`query_handling_agent.py`**  
  Управляет обработкой запросов:
  - Классификация запросов.
  - Формирование уточняющих вопросов.
  - Создание запросов в Qdrant.
  - Интеграция с `graph.py`.

- **`routing_agent.py`**  
  Координирует взаимодействие между узлами графа:
  - Вызов LLM.
  - Использование инструментов для поиска данных.
  
- **`graph.py`**  
  Основной файл с реализацией LangGraph:
  - Узлы для работы с LLM.
  - Узлы для вызова инструментов (например, Qdrant).
  - Память (MemorySaver).

---

#### **2. `pipelines/`**
- **`document_ingestion.py`**  
  Организует полный цикл обработки документов:
  - Деление на страницы и чанки.
  - Генерация summary и эмбеддингов.
  - Сохранение данных в Qdrant.
  
- **`query_resolution.py`**  
  Выполняет весь цикл обработки запросов:
  - Классификация.
  - Формирование уточняющих вопросов.
  - Поиск данных в Qdrant.
  - Компоновка ответа.

---

#### **3. `storage/`**
- **`vector_store.py`**  
  Управляет взаимодействием с Qdrant:
  - Добавление эмбеддингов и данных.
  - Поиск ближайших векторов.
  - Удаление или обновление данных.

- **`metadata_store.py`**  
  Метаданные хранятся внутри векторного представления в Qdrant.

---

#### **4. `utils/`**
- **`chunking.py`**  
  Логика деления текста на чанки с учётом ограничения токенов.
  
- **`embedding.py`**  
  Генерация векторных представлений текста с использованием локальной модели.

- **`summarization.py`**  
  Генерация кратких аннотаций для страниц.

- **`llm_utils.py`**  
  Утилиты для взаимодействия с LLM через Ollama.

---

